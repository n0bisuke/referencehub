# ReferenceHub Asset Service — Hono + Cloudflare Free Tier Design

## 1. サービス概要
- 写真・スライド素材を個人〜小規模チームでアップロードし、後から検索・再利用できるアセットライブラリ。
- ブラウザから直接アップロード、タグ付け、サムネイル閲覧、ダウンロードが可能。
- 将来のチーム利用を見据え、ユーザーロールや監査ログなどの拡張性を確保する。

## 2. 利用フレームワークと開発方針
- **Hono** をCloudflare Workers上のAPIルーターとして採用。軽量でEdge Runtime向けに最適化されており、認証・メタデータCRUD・プリサインURL発行などの動的処理を担う。
- 静的アセットはWorkersの `assets` 配信、またはCloudflare Pages（静的ビルド）で提供し、HonoはAPIのみに集中。SSGが必要な場合は `@hono/vite-ssg` などでビルド時HTML生成も可能。
- IaC/開発ツールは `wrangler` を中心に、TypeScript＋ESM構成で統一。

## 3. アーキテクチャ構成
- **Workers (Hono)**: 認証、R2のアップロード署名発行、D1メタデータ管理、KVキャッシュ更新、Cloudflare Images変換API呼び出しを担当。CPU 10ms制限内で処理できるようロジックを薄く保つ。
- **Cloudflare Pages (任意)**: UIを静的生成する場合に使用。Pages FunctionsはWorkers枠を消費するため、SSRが不要なら純静的配信＋Workers API呼び出しの構成。
- **R2**: 元画像ファイルを保存。Free枠（月10GB、Class A 100万回/日、Class B 1,000万回/日）で初期運用。
- **D1**: アセットメタ情報（タイトル、タグ、アップロード者、生成サムネイルURLなど）を保持。Free枠（5GB、1日読取500万行・書込10万行）を意識してクエリを最適化。
- **Workers KV**: 最近利用した素材やタグリスト、サムネイルURLのキャッシュを保存し、読み込み回数上限（10万回/日）内で応答時間を短縮。
- **Cloudflare Images Transformations**: R2など外部ストレージの画像を変換し、サムネイルやWebP配信用バリアントを生成。
- **Cron Triggers**: 週次のクリーンアップ（孤立データ削除、容量監視、期限切れ署名の無効化）を最大5本までの無料トリガーで実行。

## 4. データフロー
1. **Upload**  
   - 利用者がHono APIへPOST → Workersが一時トークン／署名付きURLを発行。  
   - ブラウザは直接R2へPUT（最大100MB/リクエスト）。アップロード完了後、Workersへ完了Webhookまたはクライアント通知。
2. **Metadata Registration**  
   - 完了通知を受けたWorkersがD1へメタデータ行を追加し、必要に応じてKVへタグ・サムネイルURLをキャッシュ。
3. **Thumbnail Generation**  
   - Hono APIからCloudflare Images Transformationsを呼び出してサムネイルURLを取得。URLはD1に保存し再利用することでユニーク変換数を抑制。
4. **Retrieve/Search**  
   - ユーザーが検索を行うと、WorkersがD1/KVからメタデータを取得し、アクセス権チェック後にR2署名URLまたはサムネイルURLを返却。
5. **Lifecycle Management**  
   - Cronトリガーで古い素材のアーカイブ提案・容量アラート、参照切れデータのクリーンアップ。

## 5. URLアーカイブMVP計画
- **目的**: 「URLを入力→対象ページのメタデータ・サムネイル＋利用文脈を保存して後から参照できる」体験を最初のマイルストーンとする。
- **技術スタック**: 既存のHono + Cloudflare Workers + Viteテンプレートを継続利用し、フロントはURL入力フォームと履歴リスト、APIは `/api/archive` などのエンドポイントを追加。
- **処理フロー**  
  1. フロントからURLをPOST。  
  2. Workers(Hono)がURLバリデーション → メタデータ取得（`fetch` + HTMLパース / oEmbed / OGP）。  
  3. タイトル、説明、OG画像URL、HTTPステータス、ハッシュ、送信者IDに加え、「発表で利用したスライドURL（任意）」「どんな文脈で利用したかコメント（必須）」をD1に保存。重複URLはハッシュで検知。  
  4. サムネイル画像はCloudflare Images Transformationsで生成またはOG画像をR2に転送し、結果URLをD1/KVに保持。  
  5. フロントは `/api/archives` で取得し、カードUIで表示。  
- **バックログ**: スクリーンショット取得（Browser Rendering API）、テキスト全文保存（Vectorize連携）、タグ自動付与（LLM or ルールベース）。

## 6. Notion同期 + 静的アーカイブ構想
- **二層永続化**: 新規投稿はまずD1に書き込み、`synced_to_notion` フラグを`0`で保持。15分〜1時間間隔のCron Workerが未同期行をNotion APIにまとめて反映し、成功時にフラグを更新。Notionの3req/s制限はバッチ処理で吸収。
- **編集/可視化**: Notion側ではビューやワークフロー（承認・タグ整理）を行い、社内共有や公開カタログを簡単に作成。
- **静的アーカイブ**: D1/Notionの履歴を「最新100件=動的」「101件以降=静的JSON or HTML」としてCloudflare Pages/Workers `assets` にエクスポート。静的ファイルはバージョン付き（`archives-2025-10.json` など）でCDNキャッシュし、古いデータはWorkers呼び出しゼロで閲覧可能。
- **ハイブリッド配信**: フロントは検索時に動的APIの最新データと静的アーカイブの結果をマージし、ユーザー体験を落とさずにWorkers無料枠・D1クエリ数を節約。
- **将来展望**: アーカイブ生成やNotion同期をWorkflows/Queuesへ移行すると、より大規模なバックフィルや再処理も安全に実行可能。

## 7. Cloudflare Images 最新仕様（2025-10-31確認）
- Images Freeプランは月5,000件までの **ユニーク変換** が無料。超過すると新規変換がエラー `9422` で失敗し、既存キャッシュ済みの変換は提供継続。
- 同一パラメータの変換は30日間カウントが再発生しないため、生成したサムネイルURLをD1/KVに保存して再利用する設計が有効。
- Freeプランで課金対象となるのは「外部ストレージの画像変換」のみ。R2と組み合わせる場合は Storage/Delivery 課金は発生せず、ユニーク変換数の管理だけに集中できる。
- 超過が見込まれる場合はImages Paidプランへ移行し、5,000件超過分を1,000ユニーク変換あたり$0.50で購入する。

## 8. 認証・権限管理
- Phase 1: Cloudflare Accessまたはメールリンク/OTPベースの簡易ログインでユーザーIDを確立し、D1にプロフィールと権限を保存。
- Phase 2: WebAuthnパスキー登録・認証APIをHonoに追加し、公開鍵やチャレンジ履歴をD1に保持。マルチデバイス対応をDurable Objectで調整。
- Phase 3: チーム／組織単位のロール管理・監査ログを整備し、素材ごとの共有リンクや承認フローを実装。
- 共通: アクセスログをD1またはLogsプラットフォームに送り、監査・インサイト用途に活用。

## 9. コスト管理とスケール戦略
- Workers呼び出しを1日10万リクエスト以内に抑えるため、静的キャッシュ・クライアントサイド検索を活用。ヘビー処理は `event.waitUntil` で非同期化。
- R2使用量が無料10GBに近づいたら古い素材のアーカイブ/削除フローを提示し、容量超過を抑制。
- D1の5GB/日次上限をモニタリングし、全文検索が必要な場合は軽量インデックスをKVに保持するか、有料プラン移行を検討。
- Imagesユニーク変換数はメタデータに `variants` を定義して固定化し、ユーザー入力による任意変換を禁止することで上限管理。
- 利用増加時にはWorkers Paidプラン（$5/月〜）へ移行し、必要に応じてQueuesやWorkflowsで非同期処理を構築。

## 10. 次ステップ
1. `/api/archive` → D1書き込み：HonoでURL／タグ／文脈コメント必須・スライドURL任意のバリデーションを実装し、D1挿入→結果返却までを整備。
2. `/api/archives` のD1化：検索クエリ・タグ・文脈コメントをSQL LIKEで検索し、最新100件＋総件数を返す。
3. 投稿モーダル改善：新入力項目（スライドURL／文脈コメント／任意メモ）をUIへ追加し、必須表示やエラーメッセージを整理。
4. Notion同期下準備：D1に `synced_to_notion`/`synced_at` 列を追加し、スライドURL・文脈コメントを含めたバッチAPIを設計。
5. 静的アーカイブPoC：D1 → JSONエクスポートに追加フィールドを含め、Pages `public/archives-latest.json` を更新するバッチを検証。
6. 認証基盤（Phase 1）：メールリンク/OTPログインを組み込み、ユーザーID・投稿者紐付けを開始。
