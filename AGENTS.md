# ReferenceHub Asset Service — Hono + Cloudflare Free Tier Design

## 1. サービス概要
- 写真・スライド素材を個人〜小規模チームでアップロードし、後から検索・再利用できるアセットライブラリ。
- ブラウザから直接アップロード、タグ付け、サムネイル閲覧、ダウンロードが可能。
- 将来のチーム利用を見据え、ユーザーロールや監査ログなどの拡張性を確保する。

## 2. 利用フレームワークと開発方針
- **Hono** をCloudflare Workers上のAPIルーターとして採用。軽量でEdge Runtime向けに最適化されており、認証・メタデータCRUD・プリサインURL発行などの動的処理を担う。
- 静的アセットはWorkersの `assets` 配信、またはCloudflare Pages（静的ビルド）で提供し、HonoはAPIのみに集中。SSGが必要な場合は `@hono/vite-ssg` などでビルド時HTML生成も可能。
- IaC/開発ツールは `wrangler` を中心に、TypeScript＋ESM構成で統一。

## 3. アーキテクチャ構成
- **Workers (Hono)**: 認証、R2のアップロード署名発行、D1メタデータ管理、KVキャッシュ更新、Cloudflare Images変換API呼び出しを担当。CPU 10ms制限内で処理できるようロジックを薄く保つ。
- **Cloudflare Pages (任意)**: UIを静的生成する場合に使用。Pages FunctionsはWorkers枠を消費するため、SSRが不要なら純静的配信＋Workers API呼び出しの構成。
- **R2**: 元画像ファイルを保存。Free枠（月10GB、Class A 100万回/日、Class B 1,000万回/日）で初期運用。
- **D1**: アセットメタ情報（タイトル、タグ、アップロード者、生成サムネイルURLなど）を保持。Free枠（5GB、1日読取500万行・書込10万行）を意識してクエリを最適化。
- **Workers KV**: 最近利用した素材やタグリスト、サムネイルURLのキャッシュを保存し、読み込み回数上限（10万回/日）内で応答時間を短縮。
- **Cloudflare Images Transformations**: R2など外部ストレージの画像を変換し、サムネイルやWebP配信用バリアントを生成。
- **Cron Triggers**: 週次のクリーンアップ（孤立データ削除、容量監視、期限切れ署名の無効化）を最大5本までの無料トリガーで実行。

## 4. データフロー
1. **Upload**  
   - 利用者がHono APIへPOST → Workersが一時トークン／署名付きURLを発行。  
   - ブラウザは直接R2へPUT（最大100MB/リクエスト）。アップロード完了後、Workersへ完了Webhookまたはクライアント通知。
2. **Metadata Registration**  
   - 完了通知を受けたWorkersがD1へメタデータ行を追加し、必要に応じてKVへタグ・サムネイルURLをキャッシュ。
3. **Thumbnail Generation**  
   - Hono APIからCloudflare Images Transformationsを呼び出してサムネイルURLを取得。URLはD1に保存し再利用することでユニーク変換数を抑制。
4. **Retrieve/Search**  
   - ユーザーが検索を行うと、WorkersがD1/KVからメタデータを取得し、アクセス権チェック後にR2署名URLまたはサムネイルURLを返却。
5. **Lifecycle Management**  
   - Cronトリガーで古い素材のアーカイブ提案・容量アラート、参照切れデータのクリーンアップ。

## 5. Cloudflare Images 最新仕様（2025-10-31確認）
- Images Freeプランは月5,000件までの **ユニーク変換** が無料。超過すると新規変換がエラー `9422` で失敗し、既存キャッシュ済みの変換は提供継続。
- 同一パラメータの変換は30日間カウントが再発生しないため、生成したサムネイルURLをD1/KVに保存して再利用する設計が有効。
- Freeプランで課金対象となるのは「外部ストレージの画像変換」のみ。R2と組み合わせる場合は Storage/Delivery 課金は発生せず、ユニーク変換数の管理だけに集中できる。
- 超過が見込まれる場合はImages Paidプランへ移行し、5,000件超過分を1,000ユニーク変換あたり$0.50で購入する。

## 6. 認証・権限管理
- 初期段階ではCloudflare AccessまたはJWTベースの簡易認証をHonoに実装。ユーザー情報はD1に保持し、素材ごとの閲覧権限を付与。
- 将来的なチームプランでは、アクセスログをD1または別ログ基盤に蓄積し、閲覧履歴／ダウンロード履歴を追跡できるようにする。

## 7. コスト管理とスケール戦略
- Workers呼び出しを1日10万リクエスト以内に抑えるため、静的キャッシュ・クライアントサイド検索を活用。ヘビー処理は `event.waitUntil` で非同期化。
- R2使用量が無料10GBに近づいたら古い素材のアーカイブ/削除フローを提示し、容量超過を抑制。
- D1の5GB/日次上限をモニタリングし、全文検索が必要な場合は軽量インデックスをKVに保持するか、有料プラン移行を検討。
- Imagesユニーク変換数はメタデータに `variants` を定義して固定化し、ユーザー入力による任意変換を禁止することで上限管理。
- 利用増加時にはWorkers Paidプラン（$5/月〜）へ移行し、必要に応じてQueuesやWorkflowsで非同期処理を構築。

## 8. 次ステップ
1. Hono + WranglerでAPIプロジェクトを初期化し、R2署名発行・D1接続の骨格を実装。
2. Cloudflare Images TransformationsのPoCを作成し、サムネイル生成とユニーク変換カウントの挙動を検証。
3. UIモックとメタデータスキーマ（アセット・タグ・コレクション）を設計し、D1テーブルとKVキー設計に落とし込む。
4. Cronトリガーでクリーンアップ処理を作成し、無料枠内でのメンテナンスフローを確認。
